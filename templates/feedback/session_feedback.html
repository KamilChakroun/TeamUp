{% extends "base.html" %} {% block content %}
<style>
    .div {
        padding: 5rem;
        padding-top: 5rem;
    }
</style>
<div class="container mt-4 pt-4">
    {% if feedbacks %}
    <ul class="list-group">
        <div
            class="d-flex justify-content-between align-items-center mt-3 mb-4"
        >
            <h2>Feedbacks pour la session : {{ session.title }}</h2>
            <button class="btn btn-primary" id="seeSummariesBtn">
                Voir le r√©sum√© IA üß†
            </button>
        </div>

        {% for fb in feedbacks %}
        <li class="list-group-item">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <strong>{{ fb.user.name }}</strong>
                    {% if fb.user_present %}
                    <span class="badge bg-success">Pr√©sent</span>
                    {% else %}
                    <span class="badge bg-warning text-dark">Absent</span>
                    {% endif %}
                    <br>
                    <small>Note : {{ fb.get_rating_display }}</small>
                    {% if fb.comment %}
                    <p class="mb-1 mt-2"><em>{{ fb.comment }}</em></p>
                    {% endif %}
                </div>
                {% if fb.user == request.user %}
                <div class="mt-2">
                    <a
                        href="{% url 'edit_feedback' fb.id %}"
                        class="btn btn-outline-primary btn-sm"
                    >‚úèÔ∏è Modifier</a>
                    <a
                        href="{% url 'delete_feedback' fb.id %}"
                        class="btn btn-outline-danger btn-sm"
                    >üóëÔ∏è Supprimer</a>
                </div>
                {% endif %}
            </div>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p class="text-muted">Aucun feedback pour cette session.</p>
    {% endif %}
    <div class="card my-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">üë• Participants</h5>
        </div>
        <div class="card-body">
            {% if participants %}

            <div class="row g-3 mt-3">
                {% for p in participants %}
                <div class="col-md-4 col-sm-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div
                            class="card-body d-flex flex-column align-items-center text-center"
                        >
                            <!-- Avatar or Icon -->
                            <div
                                class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center mb-3"
                                style="width: 60px; height: 60px; font-size: 1.5rem"
                            >
                                {{ p.username|slice:":1"|upper }}
                            </div>

                            <!-- Username -->
                            <h6 class="card-title mb-1">
                                {{ p.username }}
                            </h6>

                            <!-- Presence Badge -->
                            {% if p.user_present %}
                            <span class="badge bg-success mb-2">Pr√©sent</span>
                            {% else %}
                            <span class="badge bg-warning text-dark mb-2"
                            >Absent</span>
                            {% endif %}

                            <!-- Feedback Button -->
                            {% if request.user != p.user %}
                            <a
                                href="{% url 'give_participant_feedback' session.id %}?target={{ p.id }}"
                                class="btn btn-outline-primary btn-sm mt-2 w-75"
                            >
                                <i class="bi bi-chat-dots me-1"></i> Donner un
                                feedback
                            </a>
                            {% else %}
                            <button
                                class="btn btn-outline-secondary btn-sm mt-2 w-75"
                                disabled
                            >
                                <i class="bi bi-person-check me-1"></i> Moi-m√™me
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            {% else %}
            <p class="text-muted mb-0">
                Aucun participant n‚Äôa encore laiss√© de feedback.
            </p>
            {% endif %}
        </div>
    </div>
</div>
<!-- Bootstrap Modal -->
<div
    class="modal fade"
    id="aiSummaryModal"
    tabindex="-1"
    aria-labelledby="aiSummaryLabel"
    aria-hidden="true"
>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="aiSummaryLabel">
                    R√©sum√© IA de la session
                </h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                >
                </button>
            </div>
            <div class="modal-body">
                <div id="aiSummaryContent">
                    <p class="text-muted">G√©n√©ration du r√©sum√© en cours...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                >
                    Fermer
                </button>
            </div>
        </div>
    </div>
</div>
<script>
    document.getElementById("seeSummariesBtn").addEventListener(
        "click",
        async () => {
            const modal = new bootstrap.Modal(
                document.getElementById("aiSummaryModal"),
            );
            const contentDiv = document.getElementById(
                "aiSummaryContent",
            );
            contentDiv.innerHTML =
                "<p class='text-muted'>G√©n√©ration du r√©sum√© en cours...</p>";
            modal.show();

            try {
                const response = await fetch(
                    "{% url 'generate_session_summary' session.id %}",
                );
                if (!response.ok) throw new Error("Erreur serveur");
                const data = await response.json();
                let formatted = data.summary
                    .split(/-\s+/) // split on "- " to get each bullet
                    .filter((line) => line.trim().length > 0)
                    .map((line) => {
                        const parts = line.split(":");
                        if (parts.length > 1) {
                            return `<div class="list-group-item">
                <strong>${parts[0].trim()}:</strong> ${
                                parts.slice(1).join(":").trim()
                            }
              </div>`;
                        } else {
                            return `<div class="list-group-item">${line.trim()}</div>`;
                        }
                    })
                    .join("");
                contentDiv.innerHTML = `
                  <div class="list-group list-group-flush shadow-sm rounded">
                    ${formatted}
                </div>
                `;
            } catch (err) {
                contentDiv.innerHTML =
                    `<p class='text-danger'>Erreur : ${err.message}</p>`;
            }
        },
    );
</script>

{% endblock %}
